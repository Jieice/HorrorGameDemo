# 项目开发须知

## 1. 文档结构与查阅
- 所有剧情、系统、分支设计均已细化到 Documentation/剧情分章/ 各章节md文件。
- 每章文档包含剧情动机、互动内容、心理变化、环境反馈、推进逻辑，便于策划、编剧、程序、AI查阅。
- 如需扩展剧情、分支、结局，请优先在分章文档中补充和修改。

## 2. 剧情推进与系统实现
- 游戏采用 StoryManager/剧情节点系统推进，所有互动、对话、物品、环境均需绑定剧情节点ID。
- 只有当前激活节点的对象可被玩家互动，互动后自动推进到下一个节点。
- NPC、物品、环境互动均需有剧情动机和情感递进，避免无意义收集。
- 面具完整度等全局变量由 MaskManager 等系统统一管理，影响剧情分支和结局。

## 3. 协作与开发规范
- 新增剧情、分支、互动节点时，务必先在分章文档中补充设计，再进行系统实现。
- 代码实现应与剧情节点文档保持同步，便于后续AI或团队成员快速对齐进度。
- 重要系统（如对话、互动、剧情推进、分支判定）建议单独写实现说明或注释。

## 4. AI与新成员使用建议
- 如AI或新成员加入开发，请先通读 Documentation/剧情分章/ 下所有章节文档，理解剧情链条和系统结构。
- 开发过程中如遇上下文丢失、细节遗忘，可随时查阅分章文档恢复设计思路。
- 阶段性开发建议写入本须知或新建“阶段总结”文档归档。

## 5. 后续扩展建议
- 可在分章文档中预留分支、隐藏结局、可选互动等扩展点，便于后续丰富游戏内容。
- 如需大幅调整系统或剧情结构，建议先讨论并在须知中记录变更原因和方案。

## 6. 提示
- godot版本为4.5

## 7. 当前开发进度（序章完成度：95%）

### 已完成的核心系统
- **StoryManager**：线性剧情节点系统，支持物品/NPC互动、对话分支、面具完整度变化
- **对话系统**：多轮对话、分支选择、文字渐显动画（Typewriter效果）、鼠标点击推进
- **面具完整度系统**：MaskManager + UI显示（右上角图标+百分比），选择影响面具值
- **音效系统**：AudioManager（BGM、SFX、环境音），支持淡入淡出、音量控制
- **UI系统**：TaskHintUI（任务提示）、MaskUI（面具UI）、DialogueBox（恐怖风格对话框）
- **玩家控制**：移动、跑步（Shift）、蹲伏（Ctrl）、脚步声（含混响）、对话期间禁用操作

### ✨ 新增恐怖玩法系统（2025-10-04）
- **HeartRateSystem**：心率/压力管理，影响视觉和移动速度，支持深呼吸缓解（长按空格）
- **HeartRateUI**：实时心率波形显示（ECG样式），颜色随压力等级变化（绿→黄→橙→红）
- **GazeSystem**：注视检测系统，盯着物体3秒触发异常事件，自动增加心率
- **EnvironmentProgressSystem**：环境渐变系统，根据探索进度触发环境崩解效果（5阶段）
- 详细使用方法见 `Documentation/恐怖系统使用指南.md`

### 已完成的视觉效果
- **恐怖游戏滤镜**：降低饱和度、提高对比度、偏冷色调、暗角、颗粒噪点（ColorGradeFilter）
- **灯光系统**：LightingController（随机闪烁、变暗、熄灭）
- **摄像机效果**：对话时FOV轻微收窄（3秒渐变，几乎察觉不到）
- **空气尘埃粒子**：跟随玩家，发光，营造空气感

### 已完成的序章剧情节点
1. **破旧的挂钟**：心理独白 + 幻觉音效（耳语+心跳）
2. **角落的旧行李**：心理独白 + 心跳音效
3. **地上的旧票据**：心理独白
4. **陌生人对话**：多轮分支对话，FOV收窄，灯光变暗，对话结束后灯光熄灭

### 技术实现细节
- 所有系统均为Autoload单例，全局可调用
- 场景检测机制：TaskHintUI、MaskUI、ColorGradeFilter只在游戏场景显示
- 对话期间：dialogue_active统一管理，禁用玩家操作，显示鼠标
- 音效库：字典管理，便于扩展和维护
- 剧情节点：数组+字典结构，易于配置和扩展

### 最新更新（2025-10-04）
- ✅ 修复场景文件解析错误（ExtResource格式）
- ✅ 完善LightingController（添加trigger_event接口）
- ✅ 完善ScreenEffects（添加apply_brightness白光效果）
- ✅ 修复音频文件路径错误
- ✅ 优化序章环境光照（恐怖氛围+可见性平衡）
- ✅ 设置夜晚天空（天空能量0.1，不穿帮）
- ✅ 创建SimpleInteractable通用互动物品基类
- ✅ 创建GazeableStranger陌生人注视效果
- ✅ 创建PrologueEnvironment环境管理器

### 待优化项目
- 场景淡入淡出过渡
- 互动提示UI美化
- 序章开场动画
- 主菜单BGM和按钮音效
- 对话文本断句优化
- 添加序章新互动物品（标语、积水、长椅、垃圾桶）
- 启用环境渐变系统（水渍、墙皮、天花板、裂缝光）

---

> 本须知为项目开发、协作、AI辅助的基础规范，后续如有新需求请及时补充和归档。
