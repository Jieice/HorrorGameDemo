# 恐怖系统使用指南

## 已实现的系统

### 1. HeartRateSystem（心率系统）
全局单例，管理玩家的心理压力。

#### 基本用法
```gdscript
# 增加心率
HeartRateSystem.increase_heart_rate(15.0)

# 减少心率
HeartRateSystem.decrease_heart_rate(10.0)

# 获取当前心率
var current_rate = HeartRateSystem.heart_rate

# 获取压力等级
var stress = HeartRateSystem.get_stress_level()  # "normal", "elevated", "stressed", "panic"

# 获取归一化心率（0.0-1.0）
var normalized = HeartRateSystem.get_normalized_heart_rate()
```

#### 信号
```gdscript
# 心率变化
HeartRateSystem.heart_rate_changed.connect(_on_heart_rate_changed)

# 压力等级变化
HeartRateSystem.stress_level_changed.connect(_on_stress_level_changed)
```

#### 玩家交互
- 长按**空格键**：深呼吸，每秒降低5心率
- 心率>120：移动速度降低10%

### 2. GazeSystem（注视系统）
检测玩家盯着特定物体看，触发异常事件。

#### 将物体设置为可注视
方法1：添加到组
```gdscript
# 在场景中或脚本中
$Clock.add_to_group("gazeable")
```

方法2：通过代码注册
```gdscript
GazeSystem.register_gazeable_object($Clock)
```

方法3：使用元数据
```gdscript
$Clock.set_meta("gazeable", true)
```

#### 实现注视回调
在可注视对象的脚本中：
```gdscript
func _on_gaze_triggered():
    print("玩家盯着我看了3秒！")
    # 触发你的恐怖效果
    play_scary_animation()
```

#### 信号
```gdscript
# 开始注视
GazeSystem.gaze_started.connect(_on_gaze_started)

# 注视进度（用于UI提示）
GazeSystem.gaze_progress.connect(_on_gaze_progress)  # progress: 0.0-1.0

# 触发注视事件
GazeSystem.gaze_triggered.connect(_on_gaze_triggered)

# 停止注视
GazeSystem.gaze_ended.connect(_on_gaze_ended)
```

### 3. EnvironmentProgressSystem（环境进度系统）
根据调查物品数量，触发环境渐变效果。

#### 调用物品调查
```gdscript
# 当玩家调查一个物品后
EnvironmentProgressSystem.on_item_investigated()
```

#### 注册环境对象
```gdscript
# 在场景_ready中注册
EnvironmentProgressSystem.register_water_stain($WaterStain)
EnvironmentProgressSystem.register_wall_peel($WallPeel)
EnvironmentProgressSystem.register_ceiling($Ceiling)
EnvironmentProgressSystem.register_crack_light($CrackLight)
```

#### 环境对象需要实现的方法
```gdscript
# 水渍对象
func start_spreading():
    # 播放扩散动画
    pass

# 墙皮对象
func start_peeling():
    # 播放剥落动画
    pass

# 天花板对象
func start_distortion():
    # 播放扭曲动画
    pass

# 裂痕光对象
func start_glow_animation():
    # 播放发光动画
    pass
```

#### 信号
```gdscript
# 阶段变化
EnvironmentProgressSystem.stage_changed.connect(_on_stage_changed)

# 物品调查
EnvironmentProgressSystem.item_investigated.connect(_on_item_investigated)
```

### 4. HeartRateUI
自动显示在游戏场景的左下角，无需手动调用。

---

## 实战示例

### 示例1：制作一个恐怖的挂钟

```gdscript
# Clock.gd
extends StaticBody3D

@onready var animation_player = $AnimationPlayer
@onready var clock_sound = $ClockTickSound

func _ready():
    # 注册为可注视对象
    GazeSystem.register_gazeable_object(self)

# 当玩家盯着挂钟看3秒时触发
func _on_gaze_triggered():
    print("[Clock] 玩家注视触发！")
    
    # 播放逆转动画
    if animation_player:
        animation_player.play("reverse_rotation")
    
    # 播放扭曲音效
    if clock_sound:
        clock_sound.pitch_scale = 0.8
        clock_sound.play()
    
    # 播放时钟倒转音效
    if AudioManager:
        AudioManager.play_sfx("clock_reverse")
    
    # 增加玩家心率
    if HeartRateSystem:
        HeartRateSystem.increase_heart_rate(15.0)
```

### 示例2：制作互动物品触发环境变化

```gdscript
# OldLuggage.gd (角落的旧行李)
extends Interactable

var has_been_checked = false
var second_check = false

func interact():
    if not has_been_checked:
        # 首次互动
        first_interaction()
    elif not second_check:
        # 二次检查
        second_interaction()

func first_interaction():
    has_been_checked = true
    
    # 显示对话
    if DialogueManager:
        DialogueManager.show_text("一张被撕掉一半的全家福...")
    
    # 播放音效
    AudioManager.play_sfx("luggage_open")
    
    # 增加心率
    HeartRateSystem.increase_heart_rate(10.0)
    
    # 通知环境进度系统
    EnvironmentProgressSystem.on_item_investigated()
    
    # 灯光变暗
    if LightingController:
        LightingController.trigger_event("dim_briefly", 1.0)
    
    # 提示可以再次检查
    await get_tree().create_timer(2.0).timeout
    TaskHintUI.show_hint("按 [E] 再次检查", 3.0)

func second_interaction():
    second_check = true
    
    # 发现异常
    if DialogueManager:
        DialogueManager.show_text("等等...照片中多了一个人影？！")
    
    # 播放恐怖音效
    AudioManager.play_sfx("breathing_heavy")
    
    # 大幅增加心率
    HeartRateSystem.increase_heart_rate(20.0)
```

### 示例3：制作陌生人注视效果

```gdscript
# Stranger.gd
extends Node3D

@onready var animation_player = $AnimationPlayer
var is_looking_at_player = false

func _ready():
    # 注册为可注视对象
    GazeSystem.register_gazeable_object(self)
    
    # 连接注视信号
    GazeSystem.gaze_started.connect(_on_gaze_started)
    GazeSystem.gaze_ended.connect(_on_gaze_ended)

func _on_gaze_started(object):
    if object == self:
        print("[Stranger] 玩家开始盯着我看")
        # 开始慢慢抬头
        if animation_player:
            animation_player.play("look_up_slowly")

func _on_gaze_ended(object):
    if object == self:
        print("[Stranger] 玩家移开视线")
        # 恢复原状
        if animation_player:
            animation_player.play_backwards("look_up_slowly")

func _on_gaze_triggered():
    print("[Stranger] 对视触发！")
    
    # 眼睛发光
    $Eyes.visible = true
    
    # 大幅增加心率
    HeartRateSystem.increase_heart_rate(20.0)
    
    # 画面轻微扭曲
    if CameraEffects:
        CameraEffects.apply_distortion(0.3, 0.5)
    
    # 播放低频嗡鸣
    AudioManager.play_sfx("low_frequency_hum")
```

---

## 集成到StoryManager

### 更新剧情节点以使用新系统

```gdscript
# 在StoryManager.gd的物品互动中
func interact_with_object(object_id: String):
    match object_id:
        "clock":
            # 原有逻辑
            show_dialogue("这钟...早就停了吧？")
            play_sfx("child_scold")
            
            # 新增：心率和环境系统
            HeartRateSystem.increase_heart_rate(15.0)
            EnvironmentProgressSystem.on_item_investigated()
            LightingController.trigger_event("flicker", 2.0)
        
        "luggage":
            show_dialogue("一张被撕掉一半的全家福...")
            play_sfx("heartbeat")
            
            HeartRateSystem.increase_heart_rate(10.0)
            EnvironmentProgressSystem.on_item_investigated()
            LightingController.trigger_event("dim_briefly", 1.0)
```

---

## 调试技巧

### 在控制台查看状态
```gdscript
# 打印当前心率
print("心率: %.1f BPM" % HeartRateSystem.heart_rate)

# 打印环境进度
print("环境进度: %d/%d" % [EnvironmentProgressSystem.items_investigated, EnvironmentProgressSystem.total_items])

# 打印注视状态
print("注视进度: %.1f%%" % (GazeSystem.get_gaze_progress() * 100.0))
```

### 测试快捷方式
```gdscript
# 快速增加心率到危险水平
func _input(event):
    if event is InputEventKey and event.keycode == KEY_F1 and event.pressed:
        HeartRateSystem.increase_heart_rate(50.0)
    
    if event is InputEventKey and event.keycode == KEY_F2 and event.pressed:
        EnvironmentProgressSystem.on_item_investigated()
```

---

## 性能建议

1. **GazeSystem**：Raycast每帧检测，已优化
2. **HeartRateSystem**：轻量级，无性能问题
3. **EnvironmentProgressSystem**：只在触发时运行，无持续开销
4. **HeartRateUI**：UI更新已限制频率（每0.05秒）

---

## 常见问题

### Q: 心率UI不显示？
A: 检查场景名称是否包含"Subway"、"Level"或"Prologue"

### Q: 注视系统不触发？
A: 确保对象有碰撞体，并已添加到"gazeable"组

### Q: 环境变化不生效？
A: 检查是否调用了`on_item_investigated()`，并且环境对象已注册

---

**文档版本**：v1.0
**最后更新**：2025-10-04
**作者**：AI Assistant

